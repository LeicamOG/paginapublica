<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat IA Conversapp</title>
  <style>
    :root{
      --bg:#f7f7f8;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bubble-ai:#ffffff;
      --bubble-user:#f2f4f7;
      --ok:#16a34a;
      --err:#e11d48;
      --radius:16px;
      --shadow:0 10px 30px rgba(15,23,42,.06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }

    .chat-container{ width:min(100%, 460px); height:min(92vh, 720px); background:var(--panel); border:1px solid var(--line); border-radius:20px; box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto auto; overflow:hidden; margin:0 auto; position:relative }

    .chat-header{
      background:var(--panel);
      padding:16px 18px; text-align:center; font-weight:700; letter-spacing:.2px;
      color:var(--text); border-bottom:1px solid var(--line);
    }
    .chat-header .subtitle{font-weight:500; font-size:.82rem; color:var(--muted); margin-top:6px}

    .chat-messages{ flex:1; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; background:#fff }
    .chat-messages::-webkit-scrollbar{width:10px}
    .chat-messages::-webkit-scrollbar-track{background:transparent}
    .chat-messages::-webkit-scrollbar-thumb{background:#d1d5db; border-radius:99px}

    .row{display:flex; gap:10px; align-items:flex-end; width:100%}
    .row.user{justify-content:flex-end}

    .avatar, .avatar img{flex:0 0 32px; width:32px; height:32px; border-radius:50%; display:block}
    .avatar{background:#e5e7eb; border:1px solid var(--line)}
    .avatar.user{background:#e5e7eb}
    .avatar.ai{background:#fff; border:1px solid var(--line); display:flex; align-items:center; justify-content:center}
    .avatar.ai img{width:20px; height:20px}

    .bubble{
      max-width:72%; padding:12px 14px; border-radius:14px; line-height:1.5; font-size:.95rem;
      border:1px solid var(--line); box-shadow:0 2px 8px rgba(0,0,0,.04);
      transform:translateY(6px); opacity:0; animation:pop .2s ease-out forwards;
    }
    .row.ai .bubble{background:var(--bubble-ai)}
    .row.user .bubble{background:var(--bubble-user)}
    .row.error .bubble{background:#fff1f2; border-color:#fecdd3; color:#991b1b}

    @keyframes pop{to{transform:none; opacity:1}}

    .typing{display:inline-flex; gap:6px}
    .dot{width:6px; height:6px; border-radius:999px; background:#cbd5e1; opacity:.9; animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{50%{opacity:.3}}

    .chat-input{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--line); background:var(--panel);
    }
    .chat-input input{
      flex:1; border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:999px; padding:12px 14px; font-size:15px; outline:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .chat-input input:focus{border-color:#cbd5e1; box-shadow:0 0 0 4px rgba(2,6,23,.04)}

    .chat-input button{
      border:0; border-radius:999px; padding:12px 18px; font-weight:700; cursor:pointer;
      color:#111827; background:#f3f4f6; border:1px solid var(--line); box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    .chat-input button:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
    .spinner{width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .helper{color:var(--muted); font-size:.8rem; text-align:center; padding:8px 12px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); background:#fff }
  </style>
</head>
<body>

  <div class="chat-container">
    <div class="chat-header">
      Assistente de Conversa
      <div class="subtitle">Converse com a IA do Conversapp</div>
    </div>

    <div id="messages" class="chat-messages"></div>
    <div class="helper">Pressione <strong>Enter</strong> para enviar</div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Digite sua pergunta..." />
      <button id="sendButton">
        <span id="sendLabel">Enviar</span>
      </button>
    </div>
  </div>

  <script>
    // --- CONFIGURAÇÃO ---
    // Alterna automaticamente entre TESTE e PRODUÇÃO.
    // Regras:
    // 1) ?env=test  → usa endpoint de TESTE
    // 2) ?webhook=  → sobrescreve manualmente
    // 3) padrão     → PRODUÇÃO
    const URL_PARAMS = new URLSearchParams(window.location.search);
    const ENV = (URL_PARAMS.get('env') || URL_PARAMS.get('mode') || '').toLowerCase();
    const DEFAULT_WEBHOOKS = {
      test: 'https://ssn8n.conversapp.com.br/webhook-test/conversapp-chat',
      prod: 'https://swebhooks.conversapp.com.br/webhook/conversapp-chat'
    };
    const WEBHOOK_URL = URL_PARAMS.get('webhook') || (ENV === 'test' ? DEFAULT_WEBHOOKS.test : DEFAULT_WEBHOOKS.prod);

    // Dados vindos do Conversapp via querystring
    const USER_DATA = {
      iddaconta: URL_PARAMS.get('iddaconta'),
      iddoatendimento: URL_PARAMS.get('iddoatendimento')
    };

    // Validação: aborta se faltar contexto mínimo
    if (!USER_DATA.iddaconta || !USER_DATA.iddoatendimento) {
      const href = window.location.href;
      document.body.innerHTML = `
        <div class="chat-container" style="justify-content:center;align-items:center;text-align:center;padding:20px">
          <h1>Erro de configuração</h1>
          <p>A janela foi aberta, mas faltam informações da conversa na URL.</p>
          <h3>URL Recebida:</h3>
          <p style="word-break:break-all;background:#f8fafc;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:.9em">${href}</p>
          <h3>Dados encontrados:</h3>
          <ul style="text-align:left;display:inline-block;line-height:1.6">
            <li><b>iddaconta:</b> ${USER_DATA.iddaconta || '(não encontrado)'}</li>
            <li><b>iddoatendimento:</b> ${USER_DATA.iddoatendimento || '(não encontrado)'}</li>
          </ul>
          <p><b>Ação necessária:</b> verifique a configuração do botão no Conversapp. A URL deve ser parecida com:<br>
          <code>.../chat.html?iddaconta=VALOR&iddoatendimento=VALOR</code></p>
        </div>`;
      throw new Error('Parâmetros da URL ausentes.');
    }

    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const sendLabel = document.getElementById('sendLabel');

    function rowEl(sender){
      const row = document.createElement('div');
      row.className = 'row ' + (sender === 'user' ? 'user' : (sender === 'error' ? 'error' : 'ai'));

      // avatar
      let avatar;
      if(sender === 'user'){
        avatar = document.createElement('div');
        avatar.className = 'avatar user';
      } else {
        avatar = document.createElement('div');
        avatar.className = 'avatar ai';
        const img = document.createElement('img');
        img.src = 'https://leicamog.github.io/paginapublica/logosemfundosvg.svg';
        img.alt = 'Conversapp';
        img.referrerPolicy = 'no-referrer';
        img.decoding = 'async';
        avatar.appendChild(img);
      }

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if(sender !== 'user') row.appendChild(avatar);
      row.appendChild(bubble);
      if(sender === 'user') row.appendChild(avatar);
      return { row, bubble };
    }

    function addMessage(text, sender){
      const { row, bubble } = rowEl(sender);
      bubble.textContent = text;
      messagesContainer.appendChild(row);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addTyping(){
      const { row, bubble } = rowEl('ai');
      const dots = document.createElement('div');
      dots.className = 'typing';
      dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      bubble.appendChild(dots);
      messagesContainer.appendChild(row);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return () => row.remove();
    }

    function setSending(isSending){
      if(isSending){
        messageInput.disabled = true; sendButton.disabled = true; sendLabel.innerHTML = '<span class="spinner" aria-hidden="true"></span>';
      }else{
        messageInput.disabled = false; sendButton.disabled = false; sendLabel.textContent = 'Enviar';
        messageInput.focus();
      }
    }

    async function sendMessage(){
      const messageText = (messageInput.value || '').trim();
      if(!messageText) return;

      setSending(true);
      addMessage(messageText, 'user');
      messageInput.value = '';
      const stopTyping = addTyping();

      try{
        const params = new URLSearchParams({ ...USER_DATA, userMessage: messageText });
        const res = await fetch(`${WEBHOOK_URL}?${params}`, { method:'POST', headers:{ 'Content-Type':'application/json' } });

        let data = null; let text = '';
        try{ data = await res.json(); } catch{ text = await res.text(); }

        stopTyping();
        if(res.ok && data && data.status === 'success'){
          addMessage(data.response || 'Mensagem recebida.', 'ai');
        } else {
          const msg = (data && (data.message || data.error)) || text || 'Ocorreu um erro.';
          addMessage(msg, 'error');
        }
      }catch(err){
        stopTyping();
        console.error('Erro ao chamar o webhook:', err);
        addMessage('Não foi possível conectar ao assistente.', 'error');
      }finally{
        setSending(false);
      }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});

    addMessage('Olá! Analisei esta conversa. Como posso te ajudar?', 'ai');
  </script>
</body>
</html>
