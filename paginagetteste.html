<script>
    const params = new URLSearchParams(location.search);
    const TEST_MODE = params.get('test');
    const DEFAULT_WEBHOOK = 'https://ssn8n.conversapp.com.br/webhook-test/b60d2479-e3d3-4116-8d1b-51c77220bbdc';
    const N8N_WEBHOOK_URL = params.get('webhook') || DEFAULT_WEBHOOK;
    
    // !!! CONFIGURAÇÕES DO SUPABASE (JÁ ATUALIZADAS) !!!
    const SUPABASE_URL = 'https://xysupabase.conversapp.com.br';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24iLAogICJpc3MiOiAic3VwYWJhc2UiLAogICJpYXQiOiAxNzE1MDUwODAwLAogICJleHAiOiAxODcyODE3MjAwCn0._Lg9Cay-21cEQi56tidqiOkBhzjQ6kePgSRbcQfhvO8';
    
    const normalized = {
      userId: params.get('iddousuario') || params.get('userId') || null,
      accountId: params.get('idconta') || params.get('accountId') || null,
      atendimentoId: params.get('idatendimento') || params.get('atendimentoId') || null,
      contatoId: params.get('idcontato') || params.get('contatoId') || null,
      cardId: params.get('idcard') || params.get('cardId') || null,
      telefoneContato: params.get('telefone') || params.get('telefonecontato') || null,
      emailContato: params.get('email') || params.get('emailcontato') || null,
      conversationId: params.get('conversationId') || null,
      channel: params.get('channel') || 'whatsapp',
      locale: params.get('locale') || 'pt-BR',
    };

    const payload = {
      source: 'conversapp',
      event: 'gerar_resumo',
      ...normalized,
      metadata: Object.fromEntries([...params.entries()])
    };

    const statusEl = document.getElementById('status');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const loadingSection = document.getElementById('loading-section');
    const tokenFormContainer = document.getElementById('token-form-container');
    const tokenForm = document.getElementById('token-form');
    const saveTokenBtn = document.getElementById('save-token-btn');

    function setStatus(text, type){
      const hint = document.getElementById('hint');
      const hintText = document.getElementById('hintText');
      const hintIcon = document.getElementById('hintIcon');

      statusText.textContent = text;
      statusEl.classList.remove('ok','err');

      if(type==='ok'){
        statusEl.classList.add('ok');
        statusIcon.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12.5l3.2 3.2L17 8.8" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        hintText.textContent = '⚡ Seu resumo está sendo gerado! Você já pode fechar esta janela';
        hintIcon.className = '';
        hintIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="#16a34a" stroke-width="2" fill="none"/><path d="M7 12.5l3.2 3.2L17 8.8" stroke="#16a34a" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
      } else if(type==='err'){
        statusEl.classList.add('err');
        statusIcon.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l9 16H3l9-16z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 9v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1" fill="currentColor"/></svg>`;
        hintText.textContent = '⚠️ Não foi possível concluir agora. Tente novamente mais tarde ou contate o suporte.';
        hintIcon.className = '';
        hintIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l9 16H3l9-16z" stroke="#ef4444" stroke-width="2" fill="none"/><path d="M12 9v5" stroke="#ef4444" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="16.5" r="1" fill="#ef4444"/></svg>`;
      } else {
        statusIcon.innerHTML = '<span class="spinner" aria-hidden="true"></span>';
        hintText.textContent = '⚡ Seu resumo está sendo gerado! Você já pode fechar esta janela';
        hintIcon.className = 'spinner';
        hintIcon.innerHTML = '';
      }
    }
    
    // --- FUNÇÕES PARA CONTROLE DE UI E LÓGICA ---
    function showLoadingSection() {
      loadingSection.style.display = 'block';
      tokenFormContainer.style.display = 'none';
    }

    function showTokenForm() {
      loadingSection.style.display = 'none';
      tokenFormContainer.style.display = 'block';
    }

    async function checkToken(accountId) {
      if (!accountId) return null;
      // Corrigido o nome da tabela para "Tokens OpenAI - Conversapp"
      const url = `${SUPABASE_URL}/rest/v1/Tokens%20OpenAI%20-%20Conversapp?account_id=eq.${accountId}&select=openai_token`;
      const res = await fetch(url, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      });
      if (!res.ok) throw new Error('Falha ao verificar token no Supabase.');
      const data = await res.json();
      return data.length > 0 ? data[0].openai_token : null;
    }

    async function saveToken(accountId, token) {
      // Corrigido o nome da tabela para "Tokens OpenAI - Conversapp"
      const url = `${SUPABASE_URL}/rest/v1/Tokens%20OpenAI%20-%20Conversapp`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ account_id: accountId, openai_token: token })
      });
      if (!res.ok) throw new Error('Falha ao salvar token no Supabase.');
    }

    async function generateSummary() {
      setStatus('Enviando dados para a IA…', 'loading');
      if(!N8N_WEBHOOK_URL){
        setStatus('Nenhum webhook informado. Configure o endpoint.', 'err');
        return;
      }
      try{
        const res = await fetch(N8N_WEBHOOK_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          mode:'cors',
          body: JSON.stringify(payload)
        });
        if(res.ok){
          setStatus('Resumo gerado com sucesso! Você já pode fechar esta janela.', 'ok');
          autoClose(3000);
        }else{
          const msg = await res.text();
          console.warn('Webhook não-2xx', res.status, msg);
          setStatus('Falha ao gerar resumo (HTTP '+res.status+')'+(msg?': '+msg.slice(0,120):'')+'. Tente novamente.', 'err');
        }
      }catch(err){
        console.error('Erro no envio', err);
        setStatus('Erro de rede/CORS ao enviar: '+(err?.message||'Failed to fetch')+'. Verifique a conexão.', 'err');
      }
    }

    function autoClose(delay) {
      setTimeout(() => window.close(), delay);
    }

    // --- LÓGICA PRINCIPAL REESCRITA ---
    async function main() {
      if (await runTestCases()) return;

      if (!normalized.accountId) {
        setStatus('ID da conta não fornecido. Não é possível verificar o token.', 'err');
        return;
      }

      try {
        setStatus('Verificando token da OpenAI...', 'loading');
        const token = await checkToken(normalized.accountId);

        if (token) {
          console.log('Token encontrado.');
          await generateSummary();
        } else {
          console.log('Token não encontrado. Exibindo formulário.');
          setStatus('Por favor, insira seu token para continuar.', 'loading');
          showTokenForm();
        }
      } catch (error) {
        console.error('Erro na verificação do token:', error);
        setStatus('Ocorreu um erro ao verificar seu token. ' + error.message, 'err');
      }
    }

    // Event listener para o formulário
    tokenForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const tokenInput = document.getElementById('openai-token');
      const token = tokenInput.value.trim();

      if (!token || !token.startsWith('sk-')) {
        setStatus('Por favor, insira um token válido (começando com sk-).', 'err');
        return;
      }
      
      saveTokenBtn.disabled = true;
      saveTokenBtn.textContent = 'Salvando...';
      
      try {
        await saveToken(normalized.accountId, token);
        console.log('Token salvo com sucesso.');
        showLoadingSection();
        await generateSummary();
      } catch (error) {
        console.error('Erro ao salvar o token:', error);
        setStatus('Não foi possível salvar seu token. ' + error.message, 'err');
        saveTokenBtn.disabled = false;
        saveTokenBtn.textContent = 'Salvar Token e Gerar Resumo';
      }
    });

    // Função de teste existente
    async function runTestCases(){
      switch(TEST_MODE){
        case 'success': setStatus('Resumo gerado com sucesso! Você já pode fechar esta janela.', 'ok'); autoClose(3000); return true;
        case 'fail': setStatus('Simulando falha (HTTP 500)…', 'err'); return true;
        case 'badrequest': setStatus('Falha ao enviar (HTTP 400 simulado). Verifique os parâmetros.', 'err'); return true;
        case 'cors': setStatus('Simulando bloqueio CORS/sem rede…', 'err'); return true;
        case 'delay': setStatus('Simulando servidor lento (10s)…'); await new Promise(r=>setTimeout(r, 10000)); setStatus('Resumo sendo processado. Você já pode fechar esta janela.', 'ok'); autoClose(1200); return true;
        default: return false;
      }
    }

    // Inicia tudo
    main();

  </script>
