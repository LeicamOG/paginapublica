<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conversapp IA</title>
  <style>
    :root{
      --bg:#f6f7f9; --panel:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --ai:#ffffff; --user:#f3f5f7; --error:#ffe9ec; --ok:#16a34a; --danger:#e11d48;
      --radius:16px; --shadow:0 10px 30px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{width:min(100%,900px)}
    .chat{
      height:min(92vh,820px); background:var(--panel); border:1px solid var(--line);
      border-radius:24px; box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
    }
    .head{
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:18px 20px; border-bottom:1px solid var(--line); position:relative;
    }
    .head .brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:22px; letter-spacing:.2px}
    .logo{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:#eef6ed; border:1px solid #dbe7d9}
    .logo img{width:20px; height:20px}
    .sub{position:absolute; left:20px; top:22px; font-size:12px; color:var(--muted)}
    .msgs{padding:20px; overflow:auto; display:flex; flex-direction:column; gap:14px; background:#fff}
    .row{display:flex; gap:10px; align-items:flex-end}
    .row.user{justify-content:flex-end}
    .avatar{flex:0 0 30px; width:30px; height:30px; border-radius:50%; background:#eef6ed; border:1px solid #e2e8f0; display:grid; place-items:center}
    .avatar img{width:18px; height:18px}
    .bubble{
      max-width:min(76%,680px); padding:14px 16px; border-radius:14px; border:1px solid var(--line);
      line-height:1.55; font-size:15px; box-shadow:0 2px 8px rgba(0,0,0,.04); transform:translateY(6px); opacity:0;
      animation:pop .18s ease-out forwards; white-space:pre-wrap; word-wrap:break-word;
    }
    .row.ai .bubble{background:var(--ai)}
    .row.user .bubble{background:var(--user)}
    .row.error .bubble{background:var(--error); border-color:#fecdd3; color:#7f1d1d}
    .t{display:block; margin-top:6px; font-size:11px; color:#8a94a6; text-align:right}
    @keyframes pop{to{transform:none; opacity:1}}
    .typing{display:inline-flex; gap:6px}
    .dot{width:6px; height:6px; border-radius:999px; background:#cbd5e1; opacity:.9; animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{50%{opacity:.3}}

    .gate{
      display:none; grid-template-columns:1fr auto auto; gap:10px; align-items:center;
      padding:14px; border-top:1px dashed #f1c9a8; border-bottom:1px dashed #f1c9a8; background:#fff6ef;
    }
    .gate.show{display:grid}
    .gate .note{font-size:14px; color:#8b5e34}
    .gate input{
      height:40px; border:1px solid #e6d8c8; background:#fff; border-radius:10px; padding:8px 12px; font-size:14px;
    }
    .btn{
      border:1px solid var(--line); background:#0f172a; color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .btn.secondary{background:#f3f4f6; color:#111827}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .inputbar{display:flex; gap:10px; padding:14px; border-top:1px solid var(--line); background:var(--panel)}
    .inputbar input{
      flex:1; border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:999px; padding:14px 16px; font-size:15px; outline:none;
    }
    .inputbar input:disabled{background:#f8fafc}
    .helper{color:var(--muted); font-size:.82rem; text-align:center; padding:8px 12px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); background:#fff }

    /* Markdown leve */
    .bubble b{font-weight:800}
    .bubble i{font-style:italic}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chat">
      <div class="head">
        <div class="sub">Assistente de Conversa</div>
        <div class="brand">
          <span class="logo"><img src="https://leicamog.github.io/paginapublica/logosemfundosvg.svg" alt="Conversapp" referrerpolicy="no-referrer" decoding="async"></span>
          Conversapp IA
        </div>
      </div>

      <div id="messages" class="msgs"></div>

      <!-- Banner de token (aparece só quando necessário) -->
      <div id="tokenGate" class="gate">
        <div class="note">
          <b>Para continuar, precisamos da sua chave da OpenAI.</b>
          Gere em <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">platform.openai.com/api-keys</a>.
        </div>
        <input id="tokenInput" type="password" placeholder="Cole sua chave (sk-...)" />
        <button id="saveTokenBtn" class="btn">Salvar</button>
        <button id="cancelTokenBtn" class="btn secondary">Cancelar</button>
      </div>

      <div class="helper">Pressione <b>Enter</b> para enviar</div>

      <div class="inputbar">
        <input type="text" id="messageInput" placeholder="Digite sua mensagem..." />
        <button id="sendBtn" class="btn"><span id="sendLbl">Enviar</span></button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- CONFIG ----------
  const URL_PARAMS = new URLSearchParams(window.location.search);
  const ENV = (URL_PARAMS.get('env') || URL_PARAMS.get('mode') || '').toLowerCase();
  const DEFAULT_WEBHOOKS = {
    test: 'https://ssn8n.conversapp.com.br/webhook-test/conversapp-chat',
    prod: 'https://swebhooks.conversapp.com.br/webhook/conversapp-chat'
  };
  const TOKEN_SAVE = (ENV === 'test')
    ? 'https://ssn8n.conversapp.com.br/webhook-test/conversapp-save-openai-token'
    : 'https://swebhooks.conversapp.com.br/webhook/conversapp-save-openai-token';

  const WEBHOOK_URL = URL_PARAMS.get('webhook') || (ENV === 'test' ? DEFAULT_WEBHOOKS.test : DEFAULT_WEBHOOKS.prod);

  const U = {
    iddousuario: URL_PARAMS.get('iddousuario'),
    iddaconta: URL_PARAMS.get('iddaconta'),
    iddoatendimento: URL_PARAMS.get('iddoatendimento'),
    iddocontato: URL_PARAMS.get('iddocontato'),
    iddocard: URL_PARAMS.get('iddocard'),
    telefonedocontato: URL_PARAMS.get('telefonedocontato'),
    emaildocontato: URL_PARAMS.get('emaildocontato')
  };

  // ---------- GUARDS ----------
  if (!U.iddaconta || !U.iddoatendimento) {
    document.body.innerHTML = `
      <div class="wrap">
        <div class="chat" style="display:grid;place-items:center">
          <div style="text-align:center;max-width:680px;padding:24px">
            <h2>Erro de configuração</h2>
            <p>Faltam parâmetros obrigatórios na URL.</p>
            <pre style="white-space:break-spaces;background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px">${location.href}</pre>
            <p>Inclua <code>iddaconta</code> e <code>iddoatendimento</code>.</p>
          </div>
        </div>
      </div>`;
    return;
  }

  // ---------- ELEMENTOS ----------
  const $msgs = document.getElementById('messages');
  const $input = document.getElementById('messageInput');
  const $send = document.getElementById('sendBtn');
  const $sendLbl = document.getElementById('sendLbl');
  const $gate = document.getElementById('tokenGate');
  const $token = document.getElementById('tokenInput');
  const $saveToken = document.getElementById('saveTokenBtn');
  const $cancelToken = document.getElementById('cancelTokenBtn');

  // ---------- UTIL ----------
  const tz = 'America/Sao_Paulo';
  const hhmm = (d=new Date()) => new Intl.DateTimeFormat('pt-BR',{hour:'2-digit',minute:'2-digit',timeZone:tz}).format(d);

  function parseLiteMarkdown(text){
    if (!text) return '';
    // negrito: *palavra*
    text = text.replace(/\*(.+?)\*/g, '<b>$1</b>');
    // itálico: _palavra_
    text = text.replace(/_(.+?)_/g, '<i>$1</i>');
    return text;
  }

  function row(sender, html){
    const r = document.createElement('div');
    r.className = 'row ' + (sender==='user'?'user':(sender==='error'?'error':'ai'));
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    const img = document.createElement('img');
    img.src = 'https://leicamog.github.io/paginapublica/logosemfundosvg.svg';
    img.alt = 'Conversapp'; img.referrerPolicy='no-referrer'; img.decoding='async';
    avatar.appendChild(img);

    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = html;

    const t = document.createElement('span');
    t.className = 't';
    t.textContent = hhmm();

    b.appendChild(t);

    if(sender !== 'user'){ r.appendChild(avatar); r.appendChild(b); }
    else { r.appendChild(b); r.appendChild(avatar); }
    $msgs.appendChild(r);
    $msgs.scrollTop = $msgs.scrollHeight;
  }

  function addMessage(text, who='ai'){
    row(who, parseLiteMarkdown(text));
  }
  function addTyping(){
    const r = document.createElement('div');
    r.className = 'row ai';
    const avatar = document.createElement('div'); avatar.className='avatar';
    const img = document.createElement('img'); img.src='https://leicamog.github.io/paginapublica/logosemfundosvg.svg'; img.alt='Conversapp';
    avatar.appendChild(img);
    const b = document.createElement('div'); b.className='bubble';
    const dots = document.createElement('div'); dots.className='typing';
    dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    b.appendChild(dots);
    r.appendChild(avatar); r.appendChild(b);
    $msgs.appendChild(r); $msgs.scrollTop = $msgs.scrollHeight;
    return () => r.remove();
  }
  function setSending(v){
    if(v){ $input.disabled=true; $send.disabled=true; $sendLbl.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; }
    else { $input.disabled=false; $send.disabled=false; $sendLbl.textContent='Enviar'; $input.focus(); }
  }
  function tokenKey(){ return `conv.token.ok:${U.iddaconta}` }
  function setTokenGate(show){
    $gate.classList.toggle('show', !!show);
    $input.disabled = !!show;
    $send.disabled = !!show;
  }

  // ---------- TOKEN: não pedir sempre ----------
  const hasTokenHint = localStorage.getItem(tokenKey()) === '1';
  if(!hasTokenHint){
    // só mostraremos depois se o servidor pedir; começamos com input liberado.
  }

  // ---------- ENVIO ----------
  async function sendMessage(){
    const txt = ($input.value||'').trim();
    if(!txt) return;

    // Se banner de token estiver ativo, não permite enviar
    if($gate.classList.contains('show')) return;

    setSending(true);
    addMessage(txt, 'user');
    $input.value = '';
    const stopTyping = addTyping();

    try{
      const params = new URLSearchParams({
        ...U,
        userMessage: txt
      });
      const res = await fetch(`${WEBHOOK_URL}?${params}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'}
      });

      let data=null, raw='';
      try{ data=await res.json(); }catch{ raw=await res.text(); }

      stopTyping();

      if(res.ok && data){
        if(data.status === 'need_token'){ // servidor avisou que falta token
          setTokenGate(true);
          addMessage('Para continuar, precisamos do seu token da OpenAI.', 'error');
          localStorage.removeItem(tokenKey());
          return;
        }
        if(data.status === 'success'){
          addMessage(data.response||''); // ai
          // Marca que está tudo ok (não pedir de novo)
          localStorage.setItem(tokenKey(),'1');
        }else{
          addMessage((data.message||data.error||raw||'Ocorreu um erro.'),'error');
        }
      }else{
        addMessage(raw||'Não foi possível conectar ao assistente.','error');
      }
    }catch(e){
      stopTyping();
      console.error(e);
      addMessage('Falha de rede. Tente novamente.','error');
    }finally{
      setSending(false);
    }
  }

  $send.addEventListener('click', sendMessage);
  $input.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  // ---------- SALVAR TOKEN ----------
  async function saveToken(){
    const val = ($token.value||'').trim();
    if(!val) return;
    $saveToken.disabled = true;

    try{
      const res = await fetch(TOKEN_SAVE,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ iddaconta: U.iddaconta, openai_token: val })
      });
      let data=null, raw='';
      try{ data=await res.json(); }catch{ raw=await res.text(); }

      // Aceita {"status":"ok"} ou {"ok":true}
      const ok = res.ok && data && (data.status==='ok' || data.ok===true);

      if(ok){
        addMessage('Token salvo. Você já pode enviar sua mensagem. 😊','ai');
        setTokenGate(false);
        localStorage.setItem(tokenKey(),'1');
        $token.value='';
      }else{
        addMessage((data && (data.message||data.error)) || raw || 'Não consegui salvar seu token. Tente novamente.','error');
      }
    }catch(e){
      console.error(e);
      addMessage('Erro ao salvar token. Tente novamente.','error');
    }finally{
      $saveToken.disabled = false;
    }
  }
  $saveToken.addEventListener('click', saveToken);
  $cancelToken.addEventListener('click', ()=> setTokenGate(false));

  // ---------- BOAS-VINDAS ----------
  addMessage('Olá! Posso ajudar analisando seu contexto. Envie sua pergunta quando quiser.','ai');
})();
</script>
</body>
</html>
