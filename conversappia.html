<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat IA Conversapp</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bubble-ai:#ffffff;
      --bubble-user:#f3f5f7;
      --err:#e11d48;
      --ok:#16a34a;
      --radius:18px;
      --shadow:0 20px 50px rgba(15,23,42,.08);
      --shadow-sm:0 6px 20px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }

    /* Container maior, centrado */
    .chat-wrap{ width:min(100%, 980px); }
    .chat-container{
      width:100%;
      height:min(92vh, 820px);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow:var(--shadow);
      display:grid; grid-template-rows:auto auto 1fr auto;
      overflow:hidden; position:relative;
    }

    .chat-header{
      padding:18px 22px 12px; text-align:center; font-weight:800; letter-spacing:.2px;
      color:var(--text); border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fff);
    }
    .chat-subtitle{font-weight:600; font-size:.9rem; color:var(--muted); margin-top:6px}

    /* Banner para token ausente */
    .banner{
      display:none; align-items:center; justify-content:space-between; gap:16px;
      padding:12px 16px; background:#fff1f2; color:#881337; border-top:1px solid #fecdd3; border-bottom:1px solid #fecdd3;
    }
    .banner strong{display:block; margin-bottom:4px}
    .banner-actions{display:flex; gap:10px}
    .btn{
      border:1px solid var(--line); background:#f8fafc; color:#0f172a; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer;
      box-shadow:var(--shadow-sm);
    }
    .btn.primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none }

    .chat-messages{ padding:22px; overflow:auto; display:flex; flex-direction:column; gap:14px; background:#fff }
    .chat-messages::-webkit-scrollbar{width:10px}
    .chat-messages::-webkit-scrollbar-thumb{background:#d1d5db; border-radius:99px}

    .row{display:flex; gap:12px; align-items:flex-end; width:100%}
    .row.user{justify-content:flex-end}
    .row.error .bubble{background:#fff1f2; border-color:#fecdd3; color:#991b1b}

    /* Avatar maior da IA */
    .avatar, .avatar img{flex:0 0 40px; width:40px; height:40px; border-radius:50%; display:block}
    .avatar{background:#eef2f7; border:1px solid var(--line)}
    .avatar.ai{background:#fff; display:flex; align-items:center; justify-content:center}
    .avatar.ai img{width:28px; height:28px}

    .bubble{
      max-width:76%;
      padding:14px 16px; border-radius:16px; line-height:1.55; font-size:1rem;
      border:1px solid var(--line); box-shadow:0 2px 14px rgba(0,0,0,.05);
      transform:translateY(8px); opacity:0; animation:pop .18s ease-out forwards;
    }
    .row.ai .bubble{background:var(--bubble-ai)}
    .row.user .bubble{background:var(--bubble-user)}

    @keyframes pop{to{transform:none; opacity:1}}

    .typing{display:inline-flex; gap:6px}
    .dot{width:7px; height:7px; border-radius:999px; background:#cbd5e1; opacity:.9; animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{50%{opacity:.3}}

    .helper{color:var(--muted); font-size:.85rem; text-align:center; padding:8px 12px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); background:#fff }

    /* Input + botão de áudio */
    .chat-input{
      display:flex; gap:10px; padding:14px; border-top:1px solid var(--line); background:var(--panel);
    }
    .input-wrap{ position:relative; flex:1; display:flex; }
    .chat-input input{
      flex:1; border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:999px; padding:12px 16px; padding-left:48px; font-size:16px; outline:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .chat-input input:focus{border-color:#cbd5e1; box-shadow:0 0 0 4px rgba(2,6,23,.04)}

    .btn-send{
      border:0; border-radius:999px; padding:12px 18px; font-weight:800; cursor:pointer;
      color:#111827; background:#f3f4f6; border:1px solid var(--line); box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .btn-mic{
      position:absolute; left:10px; top:50%; transform:translateY(-50%);
      width:28px; height:28px; border-radius:999px; border:1px solid var(--line); background:#fff; display:grid; place-items:center; cursor:pointer;
    }
    .btn-mic[data-state="rec"]{ background:#fee2e2; border-color:#fecaca }
    .spinner{width:18px; height:18px; border:2px solid #cbd5e1; border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .small{font-size:.9rem}
  </style>
</head>
<body>
  <div class="chat-wrap">
    <div class="chat-container" role="dialog" aria-label="Assistente de Conversa">
      <div class="chat-header">
        Assistente de Conversa
        <div class="chat-subtitle">Converse com a IA do Conversapp</div>
      </div>

      <!-- Banner para token ausente -->
      <div id="tokenBanner" class="banner" role="alert">
        <div>
          <strong>Token da OpenAI não encontrado.</strong>
          Para usar a IA, cadastre sua chave de API (sk-...) nas Configurações.
        </div>
        <div class="banner-actions">
          <a id="tokenLink" class="btn" href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer">Abrir página da chave</a>
          <button id="retryBtn" class="btn primary">Já cadastrei — tentar novamente</button>
        </div>
      </div>

      <div id="messages" class="chat-messages" aria-live="polite"></div>
      <div class="helper">Pressione <strong>Enter</strong> para enviar • Clique no <strong>🎤</strong> para gravar áudio</div>

      <div class="chat-input">
        <div class="input-wrap">
          <button id="micBtn" class="btn-mic" title="Gravar áudio" aria-label="Gravar áudio">🎤</button>
          <input type="text" id="messageInput" placeholder="Digite sua pergunta..." autocomplete="off" />
        </div>
        <button id="sendButton" class="btn-send">
          <span id="sendLabel">Enviar</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURAÇÃO DE ENDPOINT =====
    const URL_PARAMS = new URLSearchParams(window.location.search);
    const ENV = (URL_PARAMS.get('env') || URL_PARAMS.get('mode') || '').toLowerCase();
    const DEFAULT_WEBHOOKS = {
      test: 'https://ssn8n.conversapp.com.br/webhook-test/conversapp-chat',
      prod: 'https://swebhooks.conversapp.com.br/webhook/conversapp-chat'
    };
    const WEBHOOK_URL = URL_PARAMS.get('webhook') || (ENV === 'test' ? DEFAULT_WEBHOOKS.test : DEFAULT_WEBHOOKS.prod);

    // ===== DADOS DA CONVERSA (todos os campos solicitados) =====
    const USER_DATA = {
      iddousuario:       URL_PARAMS.get('iddousuario'),
      iddaconta:         URL_PARAMS.get('iddaconta'),
      iddoatendimento:   URL_PARAMS.get('iddoatendimento'),
      iddocontato:       URL_PARAMS.get('iddocontato'),
      iddocard:          URL_PARAMS.get('iddocard'),
      telefonedocontato: URL_PARAMS.get('telefonedocontato'),
      emaildocontato:    URL_PARAMS.get('emaildocontato')
    };

    // ===== ELEMENTOS =====
    const messagesContainer = document.getElementById('messages');
    const messageInput      = document.getElementById('messageInput');
    const sendButton        = document.getElementById('sendButton');
    const sendLabel         = document.getElementById('sendLabel');
    const micBtn            = document.getElementById('micBtn');
    const tokenBanner       = document.getElementById('tokenBanner');
    const retryBtn          = document.getElementById('retryBtn');

    // ===== UI helpers =====
    function rowEl(sender){
      const row = document.createElement('div');
      row.className = 'row ' + (sender === 'user' ? 'user' : (sender === 'error' ? 'error' : 'ai'));

      let avatar;
      if(sender === 'user'){
        avatar = document.createElement('div');
        avatar.className = 'avatar user';
      } else {
        avatar = document.createElement('div');
        avatar.className = 'avatar ai';
        const img = document.createElement('img');
        img.src = 'https://leicamog.github.io/paginapublica/logosemfundosvg.svg';
        img.alt = 'Conversapp'; img.referrerPolicy = 'no-referrer'; img.decoding = 'async';
        avatar.appendChild(img);
      }

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if(sender !== 'user') row.appendChild(avatar);
      row.appendChild(bubble);
      if(sender === 'user') row.appendChild(avatar);
      return { row, bubble };
    }
    function addMessage(text, sender='ai'){
      const { row, bubble } = rowEl(sender);
      bubble.textContent = text;
      messagesContainer.appendChild(row);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    function addTyping(){
      const { row, bubble } = rowEl('ai');
      const dots = document.createElement('div');
      dots.className = 'typing';
      dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      bubble.appendChild(dots);
      messagesContainer.appendChild(row);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return () => row.remove();
    }
    function setSending(isSending){
      if(isSending){
        messageInput.disabled = true; sendButton.disabled = true; micBtn.disabled = true;
        sendLabel.innerHTML = '<span class="spinner" aria-hidden="true"></span>';
      }else{
        messageInput.disabled = false; sendButton.disabled = false; micBtn.disabled = false;
        sendLabel.textContent = 'Enviar';
        messageInput.focus();
      }
    }
    function showTokenBanner(show=true){
      tokenBanner.style.display = show ? 'flex' : 'none';
      // Quando não há token, bloqueia inputs
      messageInput.disabled = show; sendButton.disabled = show; micBtn.disabled = show;
    }

    // ===== Lógica principal =====
    let isRequestRunning = false;

    async function callWebhook(body, isAudio=false){
      // monta query com todos os campos
      const params = new URLSearchParams({ ...Object.fromEntries(Object.entries(USER_DATA).filter(([,v]) => v)) });

      const init = isAudio
        ? { method:'POST', body } // FormData – não definir Content-Type manualmente
        : { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body || {}) };

      const res = await fetch(`${WEBHOOK_URL}?${params}`, init);
      let data = null, txt = '';
      try { data = await res.json(); } catch { txt = await res.text(); }

      return { ok: res.ok, data, txt };
    }

    async function sendTextMessage(){
      const messageText = (messageInput.value || '').trim();
      if(!messageText || isRequestRunning) return;

      isRequestRunning = true;
      setSending(true);
      addMessage(messageText, 'user');
      messageInput.value = '';
      const stopTyping = addTyping();

      try{
        const { ok, data, txt } = await callWebhook({ userMessage: messageText });

        stopTyping();

        // Tratamento de token ausente
        const missingToken =
          (data && (data.code === 'MISSING_OPENAI_TOKEN' ||
                    /token da openai/i.test(data.message||''))) ? true : false;

        if(missingToken){
          addMessage(data.message || 'Token da OpenAI não encontrado.', 'error');
          showTokenBanner(true);
          return;
        }

        if(ok && data && data.status === 'success'){
          addMessage(data.response || 'Mensagem recebida.', 'ai');
        }else{
          addMessage((data && (data.message || data.error)) || txt || 'Ocorreu um erro.', 'error');
        }
      }catch(err){
        console.error('Erro ao chamar o webhook:', err);
        addMessage('Não foi possível conectar ao assistente.', 'error');
      }finally{
        setSending(false);
        isRequestRunning = false;
      }
    }

    // ===== Gravação de Áudio =====
    let mediaRecorder = null;
    let chunks = [];
    let recTimer = null;
    function supportsAudio(){
      return !!(navigator.mediaDevices && window.MediaRecorder);
    }

    async function toggleRecord(){
      if(!supportsAudio()){
        addMessage('Seu navegador não suporta gravação de áudio.', 'error');
        return;
      }
      if(mediaRecorder && mediaRecorder.state === 'recording'){
        mediaRecorder.stop();
        return;
      }
      // iniciar
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          micBtn.dataset.state = '';
          clearInterval(recTimer);
          const blob = new Blob(chunks, { type: 'audio/webm' });
          await sendAudio(blob);
          stream.getTracks().forEach(t => t.stop());
        };
        mediaRecorder.start();
        micBtn.dataset.state = 'rec';
        // tempo máximo 60s
        recTimer = setTimeout(()=>{ mediaRecorder?.stop(); }, 60000);
      }catch(err){
        console.error(err);
        addMessage('Permissão de microfone negada.', 'error');
      }
    }

    async function sendAudio(blob){
      if(isRequestRunning) return;
      isRequestRunning = true;
      setSending(true);
      const stopTyping = addTyping();
      try{
        const fd = new FormData();
        fd.append('media', 'audio');
        fd.append('audio', blob, 'audio.webm');

        const { ok, data, txt } = await callWebhook(fd, true);

        stopTyping();

        const missingToken =
          (data && (data.code === 'MISSING_OPENAI_TOKEN' ||
                    /token da openai/i.test(data.message||''))) ? true : false;

        if(missingToken){
          addMessage(data.message || 'Token da OpenAI não encontrado.', 'error');
          showTokenBanner(true);
          return;
        }

        if(ok && data && data.status === 'success'){
          addMessage(data.response || 'Áudio enviado. Mensagem recebida.', 'ai');
        }else{
          addMessage((data && (data.message || data.error)) || txt || 'Ocorreu um erro ao enviar o áudio.', 'error');
        }
      }catch(err){
        console.error(err);
        addMessage('Falha ao enviar o áudio.', 'error');
      }finally{
        setSending(false);
        isRequestRunning = false;
      }
    }

    // ===== Eventos =====
    sendButton.addEventListener('click', sendTextMessage);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendTextMessage(); }});
    micBtn.addEventListener('click', toggleRecord);
    retryBtn.addEventListener('click', () => { showTokenBanner(false); });

    // Mensagem inicial
    addMessage('Olá! Analisei esta conversa. Como posso te ajudar?', 'ai');
  </script>
</body>
</html>
